<style>
    /* Hidden hotspot at the top */
    #settingsHotspot {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 30px;
      z-index: 9998;
      /* Make it invisible but clickable */
      background: transparent;
      cursor: pointer;
    }

    #settingsModalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #settingsModalOverlay.show {
      display: flex;
    }

    #settingsModal {
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 8px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #settingsModal h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .settings-grid label {
      grid-column: 1 / span 1;
      align-self: center;
    }

    .settings-grid input[type="text"],
    .settings-grid input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      font-size: 14px;
    }

    .settings-grid .full-width {
      grid-column: 1 / span 2;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      padding: 6px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .color-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }

    .color-inputs {
      display: flex;
      gap: 8px;
    }

    .color-text {
      width: 110px;
      padding: 4px;
    }

    .color-picker {
      width: 40px;
      height: 32px;
      padding: 0;
      border: none;
      background: none;
    }
</style>

<div id="settingsHotspot"></div>

<div id="settingsModalOverlay">
    <div id="settingsModal">
        <h2>Settings</h2>

        <div class="settings-grid">
            <label for="INSTAGRAM_USERNAME">Instagram username</label>
            <input id="INSTAGRAM_USERNAME" name="INSTAGRAM_USERNAME" type="text"
                   placeholder="{{ defaults['INSTAGRAM_USERNAME'] }}" value="{{ instagram_username }}"/>

            <label for="FONT_SIZE">Font size</label>
            <input id="FONT_SIZE" name="FONT_SIZE" type="number" min="1" step="1" inputmode="numeric"
                   placeholder="{{ defaults['FONT_SIZE'] }}" value="{{ font_size }}"/>

            <label for="FONT_FAMILY">Font family</label>
            <input id="FONT_FAMILY" name="FONT_FAMILY" type="text" placeholder="{{ defaults['FONT_FAMILY'] }}"
                   value="{{ font_family | safe }}"/>

            <label for="PAD_CHARACTER">Padding character</label>
            <input id="PAD_CHARACTER" name="PAD_CHARACTER" type="text" maxlength="1"
                   placeholder="{{ defaults['PAD_CHARACTER'] }}" value="{{ pad_character }}"/>

            <label for="MINIMUM_DIGITS">Minimum digits</label>
            <input id="MINIMUM_DIGITS" name="MINIMUM_DIGITS" type="number" min="1" step="1" inputmode="numeric"
                   placeholder="{{ defaults['MINIMUM_DIGITS'] }}" value="{{ minimum_digits }}"/>

            <div class="color-field">
                <label for="PAGE_BG">Page background</label>
                <div class="color-inputs">
                    <input
                            id="PAGE_BG"
                            type="text"
                            class="color-text"
                            placeholder="{{ defaults['PAGE_BG'] }}"
                            maxlength="7"
                            value="{{ page_bg }}"
                    >
                    <input type="color" class="color-picker" value="{{ page_bg }}">
                </div>
            </div>

            <div class="color-field">
                <label for="FLIP_BG">Flipper background</label>
                <div class="color-inputs">
                    <input
                            id="FLIP_BG"
                            type="text"
                            class="color-text"
                            placeholder="{{ defaults['FLIP_BG'] }}"
                            maxlength="7"
                            value="{{ flip_bg }}"
                    >
                    <input type="color" class="color-picker" value="{{ flip_bg }}">
                </div>
            </div>

            <div class="color-field">
                <label for="FLIP_FG">Flipper digit</label>
                <div class="color-inputs">
                    <input
                            id="FLIP_FG"
                            type="text"
                            class="color-text"
                            placeholder="{{ defaults['FLIP_FG'] }}"
                            maxlength="7"
                            value="{{ flip_fg }}"
                    >
                    <input type="color" class="color-picker" value="{{ flip_fg }}">
                </div>
            </div>

            <div class="full-width checkbox-row">
                <input id="SHOW_IG_LOGO" name="SHOW_IG_LOGO" type="checkbox" {{ "checked" if show_ig_logo else "" }} />
                <label for="SHOW_IG_LOGO">Show Instagram logo</label>
            </div>

            <div class="full-width checkbox-row">
                <input id="SKIP_ANIMATION" name="SKIP_ANIMATION" type="checkbox" {{ "checked" if skip_animation else ""
                }} />
                <label for="SKIP_ANIMATION">Skip animation</label>
            </div>

            <label for="REFRESH_INTERVAL">Refresh interval (<output id="output">{{ refresh_interval }}</output> mins)</label>
            <input id="REFRESH_INTERVAL" name="REFRESH_INTERVAL" type="range" min="{{ minimum_refresh_interval}}"
                   max="60" step="1" value="{{ refresh_interval }}" oninput="output.value = value"/>

            <div class="full-width checkbox-row" style="margin-top: 20px; color: red; font-weight: bold;">
                <input id="LOCK_SETTINGS" name="LOCK_SETTINGS" type="checkbox"/>
                <label for="LOCK_SETTINGS">Lock settings</label>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="save()">OK</button>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);

    // Color field setup
    document.querySelectorAll(".color-field").forEach(field => {
        const text = field.querySelector(".color-text");
        const picker = field.querySelector(".color-picker");

        picker.addEventListener("input", () => {
          text.value = picker.value;
        });

        text.addEventListener("input", () => {
          const v = text.value.trim();
          if (/^#[0-9A-Fa-f]{6}$/.test(v)) {
            picker.value = v;
          }
        });
    });

    // Modal logic
    const hotspot = $("settingsHotspot");
    const modalOverlay = $("settingsModalOverlay");

    function openSettings() { modalOverlay.classList.add("show"); }
    function closeSettings() { modalOverlay.classList.remove("show"); }

    hotspot.addEventListener("dblclick", openSettings);

    let lastTapTime = 0;
    hotspot.addEventListener("touchstart", e => {
      const now = Date.now();
      if (now - lastTapTime < 300) {
        e.preventDefault();
        openSettings();
      }
      lastTapTime = now;
    });

    modalOverlay.addEventListener("click", e => {
      if (e.target === modalOverlay) closeSettings();
    });


    // Save logic
    function save() {
      const settings = {
        INSTAGRAM_USERNAME: $("INSTAGRAM_USERNAME").value,
        FONT_SIZE: parseInt($("FONT_SIZE").value, 10) || null,
        FONT_FAMILY: $("FONT_FAMILY").value,
        PAD_CHARACTER: ($("PAD_CHARACTER").value === " " ? '" "' : $("PAD_CHARACTER").value),
        MINIMUM_DIGITS: parseInt($("MINIMUM_DIGITS").value, 10) || null,
        PAGE_BG: $("PAGE_BG").value,
        FLIP_BG: $("FLIP_BG").value,
        FLIP_FG: $("FLIP_FG").value,
        REFRESH_INTERVAL: parseInt($("REFRESH_INTERVAL").value, 10),
        SHOW_IG_LOGO: $("SHOW_IG_LOGO").checked,
        SKIP_ANIMATION: $("SKIP_ANIMATION").checked,
        LOCK_SETTINGS: $("LOCK_SETTINGS").checked,
      };

      for (const [key, value] of Object.entries(settings)) {
          let v = value;

          if (typeof v === "boolean") v = v ? 1 : 0;

          if (v === "" || v === null || v === undefined) {
            document.cookie = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
            continue;
          }

          document.cookie = `${key}=${v}; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT`;
      }

      location.reload();
    }
</script>
